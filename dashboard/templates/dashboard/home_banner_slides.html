{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Home Banner Slides{% endblock %}

{% block content %}
<section class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark">Home Banner Slides</h3>
            <p class="text-secondary mb-0">Manage the rotating slides on your home page.</p>
        </div>
        <button class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#addSlideModal">
            <i class="bi bi-plus-lg me-2"></i>Add Slide
        </button>
    </div>

    <!-- Slides List -->
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="ps-4 py-3 border-0">Order</th>
                            <th class="py-3 border-0">Image</th>
                            <th class="py-3 border-0">Title</th>
                            <th class="py-3 border-0">Description</th>
                            <th class="py-3 border-0">Status</th>
                            <th class="py-3 border-0">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for slide in slides %}
                        <tr>
                            <td class="ps-4 fw-bold text-secondary">{{ slide.display_order }}</td>
                            <td>
                                <div style="width: 100px; height: 60px;">
                                    {% if slide.image %}
                                    <img src="{{ slide.image.url }}"
                                        class="w-100 h-100 object-fit-cover rounded-3 border">
                                    {% else %}
                                    <div
                                        class="w-100 h-100 bg-light rounded-3 border d-flex align-items-center justify-content-center text-muted small">
                                        No Image</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div>
                                    <div class="fw-bold text-dark">{{ slide.title1 }}</div>
                                    <div class="small text-primary">{{ slide.title2 }}</div>
                                </div>
                            </td>
                            <td>
                                <div class="small text-secondary text-truncate" style="max-width: 250px;">
                                    {{ slide.description }}
                                </div>
                                {% if slide.link %}
                                <div class="small text-muted mt-1"><i class="bi bi-link-45deg"></i> {{ slide.link }}
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                {% if slide.is_active %}
                                <span
                                    class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">Active</span>
                                {% else %}
                                <span
                                    class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-light border text-secondary shadow-sm"
                                        onclick="editSlide('{{ slide.id }}', '{{ slide.title1|escapejs }}', '{{ slide.title2|escapejs }}', '{{ slide.description|escapejs }}', '{{ slide.link|escapejs }}', '{{ slide.display_order }}', '{{ slide.is_active|yesno:'true,false' }}', '{{ slide.image.url|default:''|escapejs }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-light border text-danger shadow-sm"
                                        onclick="confirmDelete('{{ slide.id }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    <form id="delete-form-{{ slide.id }}"
                                        action="{% url 'delete-home-banner' slide.id %}" method="POST" class="d-none">
                                        {% csrf_token %}
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5 text-muted">
                                <div class="mb-3">
                                    <i class="bi bi-images display-4 opacity-25"></i>
                                </div>
                                <h6 class="fw-bold">No Slides Found</h6>
                                <p class="small mb-0">Click "Add Slide" to create your first banner slide.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block modals %}
<!-- Add Slide Modal -->
<div class="modal fade" id="addSlideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Add New Slide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{% url 'add-home-banner' %}" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="vstack gap-3">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold text-secondary text-uppercase">Display
                                    Order</label>
                                <input type="number" name="display_order"
                                    class="form-control bg-light border-0 rounded-3" value="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-secondary text-uppercase">Status</label>
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input" type="checkbox" name="is_active" checked>
                                    <label class="form-check-label small">Active</label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Main Title</label>
                            <input type="text" name="title1" class="form-control bg-light border-0 rounded-3" required
                                placeholder="e.g. Welcome to Weinber">
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Secondary
                                Title</label>
                            <input type="text" name="title2" class="form-control bg-light border-0 rounded-3" required
                                placeholder="e.g. Premium Protection">
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Description</label>
                            <textarea name="description" class="form-control bg-light border-0 rounded-3" rows="3"
                                required placeholder="Short description..."></textarea>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Link
                                (Optional)</label>
                            <input type="url" name="link" class="form-control bg-light border-0 rounded-3"
                                placeholder="https://example.com/products">
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Banner Image</label>
                            <div
                                class="p-4 border-2 border-dashed rounded-4 text-center bg-light hover:bg-gray-50 transition-colors cursor-pointer position-relative">
                                <input type="file" name="image"
                                    class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer"
                                    accept="image/*" required onchange="previewImage(this, 'addPreview')">
                                <div id="addPreview" class="d-none mb-2">
                                    <img src="" class="rounded-3 shadow-sm" style="max-height: 100px;">
                                </div>
                                <div id="addPlaceholder">
                                    <i class="bi bi-cloud-upload fs-3 text-primary mb-2"></i>
                                    <div class="small fw-bold text-dark">Click to Upload Image</div>
                                    <div class="small text-muted">Recommended: 1920x1080px</div>
                                </div>
                            </div>
                            <!-- <input type="file" name="image" class="form-control bg-light border-0 rounded-3" accept="image/*" required> -->
                        </div>

                        <button type="submit"
                            class="btn btn-primary w-100 rounded-pill py-2 fw-medium mt-3 shadow-sm">Save Slide</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Slide Modal -->
<div class="modal fade" id="editSlideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Edit Slide</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="editSlideForm" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="vstack gap-3">
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label small fw-bold text-secondary text-uppercase">Display
                                    Order</label>
                                <input type="number" name="display_order" id="editOrder"
                                    class="form-control bg-light border-0 rounded-3">
                            </div>
                            <div class="col-6">
                                <label class="form-label small fw-bold text-secondary text-uppercase">Status</label>
                                <div class="form-check form-switch mt-1">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="editActive">
                                    <label class="form-check-label small">Active</label>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Main Title</label>
                            <input type="text" name="title1" id="editTitle1"
                                class="form-control bg-light border-0 rounded-3" required>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Secondary
                                Title</label>
                            <input type="text" name="title2" id="editTitle2"
                                class="form-control bg-light border-0 rounded-3" required>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Description</label>
                            <textarea name="description" id="editDescription"
                                class="form-control bg-light border-0 rounded-3" rows="3" required></textarea>
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Link
                                (Optional)</label>
                            <input type="url" name="link" id="editLink"
                                class="form-control bg-light border-0 rounded-3">
                        </div>

                        <div>
                            <label class="form-label small fw-bold text-secondary text-uppercase">Banner Image</label>
                            <div class="p-3 border rounded-4 bg-light">
                                <div class="d-flex align-items-center gap-3">
                                    <img id="editImagePreview" src="" class="rounded-3 border bg-white"
                                        style="width: 80px; height: 50px; object-fit: cover;">
                                    <div class="flex-grow-1">
                                        <input type="file" name="image" class="form-control form-control-sm bg-white"
                                            accept="image/*">
                                        <div class="small text-muted mt-1">Leave empty to keep current image</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="submit"
                            class="btn btn-warning text-white w-100 rounded-pill py-2 fw-medium mt-3 shadow-sm">Update
                            Slide</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function editSlide(id, title1, title2, description, link, order, isActive, imageUrl) {
        let url = "{% url 'edit-home-banner' 0 %}";
        url = url.replace('0', id);
        document.getElementById('editSlideForm').action = url;

        document.getElementById('editTitle1').value = title1;
        document.getElementById('editTitle2').value = title2;
        document.getElementById('editDescription').value = description;
        document.getElementById('editLink').value = link;
        document.getElementById('editOrder').value = order;
        document.getElementById('editActive').checked = (isActive === 'true');

        const preview = document.getElementById('editImagePreview');
        if (imageUrl) {
            preview.src = imageUrl;
            preview.classList.remove('d-none');
        } else {
            preview.classList.add('d-none');
        }

        new bootstrap.Modal(document.getElementById('editSlideModal')).show();
    }

    function confirmDelete(id) {
        Swal.fire({
            title: 'Delete Slide?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('delete-form-' + id).submit();
            }
        })
    }

    function previewImage(input, previewId) {
        const previewDiv = document.getElementById(previewId);
        const placeholderDiv = document.getElementById('addPlaceholder'); // Assuming logic for add modal

        if (input.files && input.files[0]) {
            const reader = new FileReader();

            reader.onload = function (e) {
                const img = previewDiv.querySelector('img');
                img.src = e.target.result;
                previewDiv.classList.remove('d-none');
                if (placeholderDiv) placeholderDiv.classList.add('d-none');
            }

            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}