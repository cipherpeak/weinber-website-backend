{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Warranty Claims{% endblock %}

{% block content %}
<section id="warranty-claims" class="container-fluid py-4">
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 fw-bold text-secondary">Warranty Claims</h5>
                <p class="text-muted small mb-0">Manage customer warranty claims.</p>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-secondary">
                        <tr>
                            <th class="ps-4 py-3 border-0">Claim ID</th>
                            <th class="py-3 border-0">Serial No.</th>
                            <th class="py-3 border-0">Issue Date</th>
                            <th class="py-3 border-0">Status</th>
                            <th class="py-3 border-0 text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="border-top-0">
                        {% for claim in claims %}
                        <tr>
                            <td class="ps-4 fw-bold">#{{ claim.id }}</td>
                            <td class="text-secondary">{{ claim.warranty.serial_number }}</td>
                            <td class="text-secondary">{{ claim.issue_date|date:"M d, Y" }}</td>
                            <td>
                                {% if claim.status == 'pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                                {% elif claim.status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                                {% elif claim.status == 'rejected' %}
                                <span class="badge bg-danger">Rejected</span>
                                {% endif %}
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-outline-primary px-3 rounded-3" onclick="viewClaim(
                                    '{{ claim.id }}', 
                                    '{{ claim.warranty.serial_number|escapejs }}', 
                                    '{{ claim.issue_date|date:'Y-m-d' }}', 
                                    '{{ claim.issue_description|escapejs }}', 
                                    '{{ claim.status }}', 
                                    '{% if claim.warranty_card_image %}{{ claim.warranty_card_image.url|escapejs }}{% endif %}', 
                                    [{% for img in claim.images.all %}'{{ img.image.url|escapejs }}'{% if not forloop.last %},{% endif %}{% endfor %}], 
                                    '{{ claim.warranty.customer_first_name|escapejs }}', 
                                    '{{ claim.warranty.customer_last_name|escapejs }}', 
                                    '{{ claim.warranty.customer_email|escapejs }}', 
                                    '{{ claim.warranty.customer_phone|escapejs }}', 
                                    '{{ claim.warranty.vehicle_make_model|escapejs }}', 
                                    '{{ claim.warranty.chassis_number|escapejs }}', 
                                    '{{ claim.warranty.installation_date|date:'Y-m-d' }}', 
                                    '{{ claim.warranty.dealer_company_name|escapejs }}', 
                                    '{{ claim.warranty.dealer_name|escapejs }}', 
                                    '{{ claim.warranty.dealer_email|escapejs }}', 
                                    '{{ claim.warranty.dealer_phone|escapejs }}', 
                                    '{{ claim.warranty.dealer_address|escapejs }}', 
                                    [{% for item in claim.warranty.items.all %}{'product': '{{item.product|escapejs}}', 'type': '{{item.application_type|escapejs}}'}{% if not forloop.last %},{% endif %}{% endfor %}]
                                )" title="View Details">
                                    <i class="bi bi-eye"></i> View
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <h6 class="fw-bold">No Claims Found</h6>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block modals %}
<!-- View Claim Modal -->
<div class="modal fade" id="viewClaimModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom-0 pb-0">
                <div class="w-100 text-center position-relative">
                    <h4 class="modal-title fw-bold text-primary">Claim Details</h4>
                    <button type="button" class="btn-close position-absolute top-0 end-0" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-4 pt-2">
                <form id="claimStatusForm" method="POST">
                    {% csrf_token %}
                    <div class="row g-4">
                        <!-- CLAIM DETAILS -->
                        <div class="col-12">
                            <h6 class="fw-bold text-uppercase text-secondary border-bottom pb-2 mb-3">Claim Information
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Serial Number</label>
                                    <p id="viewSerialNumber" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Issue Date</label>
                                    <p id="viewIssueDate" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-12">
                                    <label class="small text-muted fw-bold">Issue Description</label>
                                    <p id="viewIssueDescription" class="bg-light p-3 rounded-3 mb-0">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- CUSTOMER & VEHICLE -->
                        <div class="col-12">
                            <h6 class="fw-bold text-uppercase text-secondary border-bottom pb-2 mb-3">Customer & Vehicle
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Customer Name</label>
                                    <p id="viewCustomerName" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Contact Info</label>
                                    <p class="mb-0 text-dark break-word"><span id="viewCustomerEmail">-</span><br><span
                                            id="viewCustomerPhone">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Vehicle</label>
                                    <p id="viewVehicle" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Chassis Number</label>
                                    <p id="viewChassis" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Install Date</label>
                                    <p id="viewInstallDate" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- PRODUCTS -->
                        <div class="col-12">
                            <h6 class="fw-bold text-uppercase text-secondary border-bottom pb-2 mb-3">Protected Products
                            </h6>
                            <div id="viewProductsContainer" class="bg-light p-3 rounded-3">
                                <!-- JS Populated -->
                            </div>
                        </div>

                        <!-- DEALER INFO -->
                        <div class="col-12">
                            <h6 class="fw-bold text-uppercase text-secondary border-bottom pb-2 mb-3">Dealer Information
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Dealer/Company</label>
                                    <p id="viewDealerName" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                                <div class="col-md-6">
                                    <label class="small text-muted fw-bold">Contact</label>
                                    <p class="mb-0 text-dark break-word"><span id="viewDealerEmail">-</span><br><span
                                            id="viewDealerPhone">-</span></p>
                                </div>
                                <div class="col-12">
                                    <label class="small text-muted fw-bold">Address</label>
                                    <p id="viewDealerAddress" class="fw-medium mb-0 text-dark">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- FILES -->
                        <div class="col-12">
                            <h6 class="fw-bold text-uppercase text-secondary border-bottom pb-2 mb-3">Proof & Documents
                            </h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="small text-muted fw-bold d-block mb-2">Warranty Card (Claim)</label>
                                    <a id="viewWarrantyCard" href="#" target="_blank"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-file-earmark-image me-1"></i> View Card
                                    </a>
                                    <span id="noWarrantyCard" class="text-muted small fst-italic ms-2"
                                        style="display:none;">Not provided</span>
                                </div>

                                <div class="col-12">
                                    <label class="small text-muted fw-bold d-block mb-2">Proof of Purchase</label>
                                    <a id="viewProofOfPurchase" href="#" target="_blank"
                                        class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-receipt me-1"></i> View Proof
                                    </a>
                                    <span id="noProofOfPurchase" class="text-muted small fst-italic ms-2"
                                        style="display:none;">Not provided</span>
                                </div>

                                <div class="col-12">
                                    <label class="small text-muted fw-bold d-block mb-2">Supporting Images</label>
                                    <div id="viewSupportingImages" class="d-flex gap-2 flex-wrap">
                                        <!-- Images will be inserted here -->
                                    </div>
                                    <span id="noSupportingImages" class="text-muted small fst-italic"
                                        style="display:none;">No images uploaded</span>
                                </div>
                            </div>
                        </div>

                        <!-- ACTION -->
                        <div class="col-12 mt-4 pt-3 border-top bg-light rounded-3 p-3">
                            <label class="form-label fw-bold text-primary mb-2">Update Claim Status</label>
                            <div class="d-flex gap-2 align-items-center">
                                <select name="status" id="statusSelect" class="form-select w-auto border-primary">
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <button type="submit" class="btn btn-primary px-4 fw-bold">Update Status</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function viewClaim(
        id, serial, date, desc, status, cardUrl, images,
        custFirst, custLast, custEmail, custPhone,
        vehicle, chassis, installDate, proofUrl,
        dealerComp, dealerName, dealerEmail, dealerPhone, dealerAddr,
        products
    ) {
        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = val || '-';
        };

        // Claim Info
        setText('viewSerialNumber', serial);
        setText('viewIssueDate', date);
        setText('viewIssueDescription', desc);

        // Customer Info
        setText('viewCustomerName', custFirst + ' ' + custLast);
        setText('viewCustomerEmail', custEmail);
        setText('viewCustomerPhone', custPhone);

        // Vehicle Info
        setText('viewVehicle', vehicle);
        setText('viewChassis', chassis);
        setText('viewInstallDate', installDate);

        // Dealer Info
        const dName = dealerComp ? `${dealerComp} (${dealerName})` : dealerName;
        setText('viewDealerName', dName);
        setText('viewDealerEmail', dealerEmail);
        setText('viewDealerPhone', dealerPhone);
        setText('viewDealerAddress', dealerAddr);

        // Products
        const prodContainer = document.getElementById('viewProductsContainer');
        if (prodContainer) {
            prodContainer.innerHTML = '';
            if (products && products.length > 0) {
                products.forEach(p => {
                    const badge = document.createElement('div');
                    badge.className = 'd-flex justify-content-between align-items-center mb-2 border-bottom pb-2';
                    badge.innerHTML = `<span class="fw-bold text-dark">${p.product}</span> <span class="badge bg-secondary text-white">${p.type}</span>`;
                    prodContainer.appendChild(badge);
                });
            } else {
                prodContainer.innerHTML = '<span class="text-muted small fst-italic">No products listed</span>';
            }
        }

        // Setup Form Action
        const form = document.getElementById('claimStatusForm');
        form.action = `/dashboard/warranty-claims/status/${id}/`;

        // Set Status
        document.getElementById('statusSelect').value = status;

        // Warranty Card Link
        const cardLink = document.getElementById('viewWarrantyCard');
        const noCard = document.getElementById('noWarrantyCard');
        if (cardUrl) {
            cardLink.href = cardUrl;
            cardLink.style.display = 'inline-flex';
            noCard.style.display = 'none';
        } else {
            cardLink.style.display = 'none';
            noCard.style.display = 'inline';
        }

        // Proof of Purchase Link
        const proofLink = document.getElementById('viewProofOfPurchase');
        const noProof = document.getElementById('noProofOfPurchase');
        if (proofUrl) {
            proofLink.href = proofUrl;
            proofLink.style.display = 'inline-flex';
            noProof.style.display = 'none';
        } else {
            proofLink.style.display = 'none';
            noProof.style.display = 'inline';
        }

        // Supporting Images
        const imgContainer = document.getElementById('viewSupportingImages');
        const noImages = document.getElementById('noSupportingImages');
        imgContainer.innerHTML = '';

        if (images && images.length > 0) {
            noImages.style.display = 'none';
            images.forEach(url => {
                const a = document.createElement('a');
                a.href = url;
                a.target = '_blank';
                a.className = 'd-block';
                a.innerHTML = `<img src="${url}" class="rounded-3 border shadow-sm" style="width: 80px; height: 80px; object-fit: cover;">`;
                imgContainer.appendChild(a);
            });
        } else {
            noImages.style.display = 'block';
        }

        new bootstrap.Modal(document.getElementById('viewClaimModal')).show();
    }
</script>
{% endblock %}